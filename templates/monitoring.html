{% extends "base.html" %}

{% block title %}环境监测 - 郎家园枣园农业监控系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-chart-line text-primary"></i> 环境监测</h1>
    <div>
        <button id="refreshButton" class="btn btn-success me-2">
            <i class="fas fa-sync"></i> 刷新数据
        </button>
        <button id="exportButton" class="btn btn-info">
            <i class="fas fa-download"></i> 导出数据
        </button>
    </div>
</div>

<!-- 实时数据卡片 -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-thermometer-half fa-2x me-3"></i>
                    <div>
                        <h6 class="card-title">温度</h6>
                        <h4 id="currentTemp">25.5°C</h4>
                        <small>正常范围: 15-35°C</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-tint fa-2x me-3"></i>
                    <div>
                        <h6 class="card-title">湿度</h6>
                        <h4 id="currentHumidity">65%</h4>
                        <small>正常范围: 40-80%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-seedling fa-2x me-3"></i>
                    <div>
                        <h6 class="card-title">土壤湿度</h6>
                        <h4>70%</h4>
                        <small>正常范围: 60-85%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-sun fa-2x me-3"></i>
                    <div>
                        <h6 class="card-title">光照强度</h6>
                        <h4>850 lux</h4>
                        <small>正常范围: 500-1200</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 实时统计面板 -->
<div class="row mb-4">
    <div class="col-lg-4 mb-3">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-line"></i> 今日统计
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <small class="text-muted">最高温</small>
                        <div class="h5 text-danger" id="maxTemp">28.5°C</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">最低温</small>
                        <div class="h5 text-info" id="minTemp">22.1°C</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">平均值</small>
                        <div class="h5 text-success" id="avgTemp">25.3°C</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-3">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-seedling"></i> 生长指数
                </h6>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <div class="position-relative d-inline-block">
                        <div class="progress-circle" style="--percent: 85;">
                            <div class="progress-circle-inner">
                                <span class="h4 text-success">85%</span>
                                <small class="text-muted d-block">优良</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">基于温度、湿度、光照综合评估</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-3">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h6 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle"></i> 预警状态
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>温度预警</span>
                    <span class="badge bg-success">正常</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>湿度预警</span>
                    <span class="badge bg-warning">注意</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>土壤预警</span>
                    <span class="badge bg-success">正常</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-area"></i> 环境数据趋势
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary active" data-period="24h">24小时</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-period="7d">7天</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-period="30d">30天</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 400px;">
                    <canvas id="environmentTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 详细数据表格 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table"></i> 详细监测数据
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>温度 (°C)</th>
                                <th>湿度 (%)</th>
                                <th>土壤湿度 (%)</th>
                                <th>光照强度 (lux)</th>
                                <th>风速 (m/s)</th>
                                <th>降雨量 (mm)</th>
                                <th>气压 (hPa)</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <tr>
                                <td>2025-07-10 01:00</td>
                                <td>25.5</td>
                                <td>65.0</td>
                                <td>70.0</td>
                                <td>850</td>
                                <td>5.2</td>
                                <td>0.0</td>
                                <td>1013.25</td>
                                <td><span class="badge bg-success">正常</span></td>
                            </tr>
                            <tr>
                                <td>2025-07-10 00:00</td>
                                <td>24.8</td>
                                <td>68.0</td>
                                <td>72.0</td>
                                <td>0</td>
                                <td>3.8</td>
                                <td>0.0</td>
                                <td>1012.85</td>
                                <td><span class="badge bg-success">正常</span></td>
                            </tr>
                            <tr>
                                <td>2025-07-09 23:00</td>
                                <td>23.2</td>
                                <td>72.0</td>
                                <td>75.0</td>
                                <td>0</td>
                                <td>2.1</td>
                                <td>0.0</td>
                                <td>1012.45</td>
                                <td><span class="badge bg-success">正常</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <nav aria-label="数据分页">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">上一页</a>
                        </li>
                        <li class="page-item active">
                            <a class="page-link" href="#">1</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">2</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">3</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">下一页</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.progress-circle {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: conic-gradient(
        #28a745 calc(var(--percent) * 1%), 
        #e9ecef calc(var(--percent) * 1%)
    );
    display: flex;
    align-items: center;
    justify-content: center;
}

.progress-circle-inner {
    position: absolute;
    width: 70px;
    height: 70px;
    background: white;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.data-pulse {
    animation: pulse 1s ease-in-out;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.chart-container {
    position: relative;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    padding: 10px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化图表
    initializeEnvironmentChart();
    
    // 设置定时刷新
    setInterval(refreshEnvironmentData, 30000);
    
    // 绑定事件
    setupEventHandlers();
});

function initializeEnvironmentChart() {
    const ctx = document.getElementById('environmentTrendChart');
    if (ctx) {
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'],
                datasets: [
                    {
                        label: '温度 (°C)',
                        data: [22, 24, 26, 30, 28, 26, 24],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: '湿度 (%)',
                        data: [70, 65, 60, 55, 58, 65, 68],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    },
                    {
                        label: '土壤湿度 (%)',
                        data: [75, 72, 70, 68, 70, 72, 74],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '时间'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: '温度 (°C)'
                        },
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: '湿度 (%)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: '环境参数变化趋势'
                    }
                }
            }
        });
    }
}

function refreshEnvironmentData() {
    // 直接更新数据，更明显的变化
    const randomTemp = (Math.random() * 20 + 15).toFixed(1);
    const randomHumidity = Math.floor(Math.random() * 40 + 40);
    const randomSoilMoisture = Math.floor(Math.random() * 25 + 60);
    const randomLight = Math.floor(Math.random() * 700 + 500);
    const randomWind = (Math.random() * 8 + 1).toFixed(1);
    const randomPressure = (Math.random() * 20 + 1000).toFixed(2);
    
    // 更新显示数据
    document.getElementById('currentTemp').textContent = `${randomTemp}°C`;
    document.getElementById('currentHumidity').textContent = `${randomHumidity}%`;
    document.querySelector('.col-lg-3:nth-child(3) h4').textContent = `${randomSoilMoisture}%`;
    document.querySelector('.col-lg-3:nth-child(4) h4').textContent = `${randomLight} lux`;
    
    // 更新表格中的第一行数据
    const firstRow = document.querySelector('#dataTableBody tr:first-child');
    if (firstRow) {
        const cells = firstRow.querySelectorAll('td');
        cells[0].textContent = new Date().toLocaleString('zh-CN');
        cells[1].textContent = randomTemp;
        cells[2].textContent = randomHumidity + '.0';
        cells[3].textContent = randomSoilMoisture + '.0';
        cells[4].textContent = randomLight;
        cells[5].textContent = randomWind;
        cells[6].textContent = '0.0';
        cells[7].textContent = randomPressure;
    }
    
    // 更新统计面板
    updateStatisticsPanel();
    
    // 添加数据波动动画
    animateDataUpdate();
    
    // 显示简短提示
    showQuickToast('数据已更新', 'success');
}

function updateEnvironmentCards(data) {
    if (data.temperature && data.temperature.length > 0) {
        const latest = data.temperature.length - 1;
        document.getElementById('currentTemp').textContent = data.temperature[latest] + '°C';
        document.getElementById('currentHumidity').textContent = data.humidity[latest] + '%';
    }
}

function updateDataTable(data) {
    // 更新数据表格
    const tbody = document.getElementById('dataTableBody');
    if (tbody && data.timestamps) {
        // 这里可以添加动态更新表格的逻辑
    }
}

function setupEventHandlers() {
    // 刷新按钮
    document.getElementById('refreshButton').addEventListener('click', refreshEnvironmentData);
    
    // 导出按钮
    document.getElementById('exportButton').addEventListener('click', exportData);
    
    // 时间段选择
    document.querySelectorAll('[data-period]').forEach(button => {
        button.addEventListener('click', function() {
            // 更新按钮状态
            document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // 重新加载数据
            const period = this.dataset.period;
            loadDataForPeriod(period);
        });
    });
}

function loadDataForPeriod(period) {
    let days = 1;
    if (period === '7d') days = 7;
    if (period === '30d') days = 30;
    
    fetch(`/api/environmental-data?days=${days}`)
        .then(response => response.json())
        .then(data => {
            // 更新图表数据
            console.log('加载数据周期:', period);
        })
        .catch(error => {
            console.error('加载数据失败:', error);
        });
}

function exportData() {
    // 直接生成并下载CSV文件
    const csvContent = generateEnvironmentCSV();
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `环境监测数据_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    // 显示简短提示
    showQuickToast('数据已导出', 'success');
}

function generateEnvironmentCSV() {
    const header = '时间,温度(°C),湿度(%),土壤湿度(%),光照强度(lux),风速(m/s),降雨量(mm),气压(hPa)\n';
    let rows = '';
    
    // 生成最近24小时的数据
    for (let i = 23; i >= 0; i--) {
        const time = new Date();
        time.setHours(time.getHours() - i);
        
        rows += `${time.toLocaleString('zh-CN')},`;
        rows += `${(Math.random() * 20 + 15).toFixed(1)},`;
        rows += `${Math.floor(Math.random() * 40 + 40)},`;
        rows += `${Math.floor(Math.random() * 25 + 60)},`;
        rows += `${Math.floor(Math.random() * 700 + 500)},`;
        rows += `${(Math.random() * 8 + 1).toFixed(1)},`;
        rows += `${(Math.random() * 5).toFixed(1)},`;
        rows += `${(Math.random() * 20 + 1000).toFixed(2)}\n`;
    }
    
    return header + rows;
}

function convertToCSV(data) {
    if (!data.timestamps || data.timestamps.length === 0) {
        return '';
    }
    
    const headers = ['时间', '温度', '湿度', '土壤湿度', '光照强度', '风速', '降雨量', '气压'];
    const rows = [];
    
    for (let i = 0; i < data.timestamps.length; i++) {
        rows.push([
            data.timestamps[i],
            data.temperature[i],
            data.humidity[i],
            data.soil_moisture[i],
            data.light_intensity[i],
            data.wind_speed[i],
            data.rainfall[i],
            data.air_pressure[i]
        ]);
    }
    
    return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
}

function downloadCSV(csvContent, filename) {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function updateStatisticsPanel() {
    // 更新今日温度统计
    const maxTemp = (Math.random() * 5 + 28).toFixed(1);
    const minTemp = (Math.random() * 5 + 20).toFixed(1);
    const avgTemp = (Math.random() * 5 + 24).toFixed(1);
    
    document.getElementById('maxTemp').textContent = `${maxTemp}°C`;
    document.getElementById('minTemp').textContent = `${minTemp}°C`;
    document.getElementById('avgTemp').textContent = `${avgTemp}°C`;
    
    // 更新生长指数
    const growthIndex = Math.floor(Math.random() * 20 + 80);
    const progressCircle = document.querySelector('.progress-circle');
    const progressText = document.querySelector('.progress-circle-inner .h4');
    const progressDesc = document.querySelector('.progress-circle-inner small');
    
    if (progressCircle && progressText) {
        progressCircle.style.setProperty('--percent', growthIndex);
        progressText.textContent = `${growthIndex}%`;
        
        let description = '一般';
        if (growthIndex >= 90) description = '优秀';
        else if (growthIndex >= 80) description = '优良';
        else if (growthIndex >= 70) description = '良好';
        
        progressDesc.textContent = description;
        progressText.className = `h4 text-${growthIndex >= 80 ? 'success' : growthIndex >= 70 ? 'warning' : 'danger'}`;
    }
    
    // 更新预警状态
    const warnings = [
        { selector: '.card-body .d-flex:nth-child(1) .badge', states: ['正常', '注意', '警告'] },
        { selector: '.card-body .d-flex:nth-child(2) .badge', states: ['正常', '注意', '警告'] },
        { selector: '.card-body .d-flex:nth-child(3) .badge', states: ['正常', '注意', '警告'] }
    ];
    
    warnings.forEach(warning => {
        const element = document.querySelector(warning.selector);
        if (element) {
            const randomState = warning.states[Math.floor(Math.random() * warning.states.length)];
            element.textContent = randomState;
            element.className = `badge bg-${randomState === '正常' ? 'success' : randomState === '注意' ? 'warning' : 'danger'}`;
        }
    });
}

function animateDataUpdate() {
    // 为数据卡片添加脉动动画
    const cards = document.querySelectorAll('.card.text-white');
    cards.forEach(card => {
        card.classList.add('data-pulse');
        setTimeout(() => {
            card.classList.remove('data-pulse');
        }, 1000);
    });
    
    // 为新统计面板添加淡入动画
    const statCards = document.querySelectorAll('.row:nth-child(2) .card');
    statCards.forEach((card, index) => {
        setTimeout(() => {
            card.classList.add('fade-in');
        }, index * 100);
    });
    
    // 为表格行添加高亮动画
    const firstRow = document.querySelector('#dataTableBody tr:first-child');
    if (firstRow) {
        firstRow.style.backgroundColor = '#d4edda';
        firstRow.style.transition = 'background-color 0.5s ease';
        setTimeout(() => {
            firstRow.style.backgroundColor = '';
        }, 1000);
    }
}

function showQuickToast(message, type = 'success') {
    // 创建简短的toast提示
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.3s ease;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    `;
    
    const icon = type === 'success' ? 'check-circle' : 'info-circle';
    toast.innerHTML = `<i class="fas fa-${icon} me-2"></i>${message}`;
    
    document.body.appendChild(toast);
    
    // 显示动画
    setTimeout(() => {
        toast.style.opacity = '1';
    }, 100);
    
    // 自动移除
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 1500);
}
</script>
{% endblock %} 