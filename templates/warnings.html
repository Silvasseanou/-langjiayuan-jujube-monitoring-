{% extends "base.html" %}

{% block title %}预警系统 - 郎家园枣园农业监控系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-exclamation-triangle text-warning"></i> 预警系统</h1>
    <div>
        <button id="refreshWarnings" class="btn btn-success me-2">
            <i class="fas fa-sync"></i> 刷新预警
        </button>
        <button id="addWarning" class="btn btn-primary">
            <i class="fas fa-plus"></i> 新增预警
        </button>
    </div>
</div>

<!-- 预警统计 -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-circle fa-2x me-3"></i>
                    <div>
                        <h6 class="card-title">紧急预警</h6>
                        <h4>2</h4>
                        <small>需要立即处理</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                    <div>
                        <h6 class="card-title">重要预警</h6>
                        <h4>5</h4>
                        <small>24小时内处理</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle fa-2x me-3"></i>
                    <div>
                        <h6 class="card-title">一般预警</h6>
                        <h4>8</h4>
                        <small>一周内处理</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle fa-2x me-3"></i>
                    <div>
                        <h6 class="card-title">已处理</h6>
                        <h4>23</h4>
                        <small>本月处理完成</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 实时预警 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bell"></i> 实时预警信息
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-danger d-flex align-items-center">
                    <i class="fas fa-exclamation-circle fa-2x me-3"></i>
                    <div>
                        <strong>紧急预警:</strong> 检测到蚜虫密度超过警戒值！
                        <br><small>时间: 2025-07-10 01:30 | 区域: A区第3排</small>
                    </div>
                    <button class="btn btn-sm btn-outline-light ms-auto">处理</button>
                </div>
                
                <div class="alert alert-warning d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                    <div>
                        <strong>重要预警:</strong> 土壤湿度持续偏低，建议增加灌溉
                        <br><small>时间: 2025-07-10 01:15 | 区域: B区第1-5排</small>
                    </div>
                    <button class="btn btn-sm btn-outline-dark ms-auto">处理</button>
                </div>
                
                <div class="alert alert-info d-flex align-items-center">
                    <i class="fas fa-info-circle fa-2x me-3"></i>
                    <div>
                        <strong>一般预警:</strong> 叶面温度略高，建议适当遮阴
                        <br><small>时间: 2025-07-10 00:45 | 区域: C区第2-4排</small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary ms-auto">处理</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 预警分类 -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie"></i> 预警分类统计
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="warningTypeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line"></i> 预警趋势分析
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="warningTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 预警列表 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list"></i> 预警历史记录
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-secondary active" data-filter="all">全部</button>
                        <button type="button" class="btn btn-sm btn-outline-danger" data-filter="urgent">紧急</button>
                        <button type="button" class="btn btn-sm btn-outline-warning" data-filter="important">重要</button>
                        <button type="button" class="btn btn-sm btn-outline-info" data-filter="normal">一般</button>
                        <button type="button" class="btn btn-sm btn-outline-success" data-filter="processed">已处理</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>类型</th>
                                <th>级别</th>
                                <th>区域</th>
                                <th>内容</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="warningTableBody">
                            <tr>
                                <td>2025-07-10 01:30</td>
                                <td><span class="badge bg-danger">病虫害</span></td>
                                <td><span class="badge bg-danger">紧急</span></td>
                                <td>A区第3排</td>
                                <td>蚜虫密度超过警戒值</td>
                                <td><span class="badge bg-warning">待处理</span></td>
                                <td>
                                    <button class="btn btn-sm btn-primary me-1">查看</button>
                                    <button class="btn btn-sm btn-success">处理</button>
                                </td>
                            </tr>
                            <tr>
                                <td>2025-07-10 01:15</td>
                                <td><span class="badge bg-info">环境</span></td>
                                <td><span class="badge bg-warning">重要</span></td>
                                <td>B区第1-5排</td>
                                <td>土壤湿度持续偏低</td>
                                <td><span class="badge bg-warning">待处理</span></td>
                                <td>
                                    <button class="btn btn-sm btn-primary me-1">查看</button>
                                    <button class="btn btn-sm btn-success">处理</button>
                                </td>
                            </tr>
                            <tr>
                                <td>2025-07-10 00:45</td>
                                <td><span class="badge bg-warning">温度</span></td>
                                <td><span class="badge bg-info">一般</span></td>
                                <td>C区第2-4排</td>
                                <td>叶面温度略高</td>
                                <td><span class="badge bg-warning">待处理</span></td>
                                <td>
                                    <button class="btn btn-sm btn-primary me-1">查看</button>
                                    <button class="btn btn-sm btn-success">处理</button>
                                </td>
                            </tr>
                            <tr>
                                <td>2025-07-09 23:20</td>
                                <td><span class="badge bg-secondary">设备</span></td>
                                <td><span class="badge bg-warning">重要</span></td>
                                <td>监控中心</td>
                                <td>传感器信号异常</td>
                                <td><span class="badge bg-success">已处理</span></td>
                                <td>
                                    <button class="btn btn-sm btn-primary me-1">查看</button>
                                    <button class="btn btn-sm btn-secondary" disabled>已完成</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <nav aria-label="预警记录分页">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">上一页</a>
                        </li>
                        <li class="page-item active">
                            <a class="page-link" href="#">1</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">2</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">3</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">下一页</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- 预警设置模态框 -->
<div class="modal fade" id="warningSettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">预警设置</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="warningSettingsForm">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>温度预警</h6>
                            <div class="mb-3">
                                <label class="form-label">高温预警阈值 (°C)</label>
                                <input type="number" class="form-control" value="35" min="25" max="50">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">低温预警阈值 (°C)</label>
                                <input type="number" class="form-control" value="10" min="0" max="20">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>湿度预警</h6>
                            <div class="mb-3">
                                <label class="form-label">高湿预警阈值 (%)</label>
                                <input type="number" class="form-control" value="85" min="70" max="100">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">低湿预警阈值 (%)</label>
                                <input type="number" class="form-control" value="30" min="0" max="50">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>土壤湿度预警</h6>
                            <div class="mb-3">
                                <label class="form-label">低土壤湿度阈值 (%)</label>
                                <input type="number" class="form-control" value="40" min="20" max="60">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>通知设置</h6>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="emailNotification" checked>
                                    <label class="form-check-label" for="emailNotification">
                                        邮件通知
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="smsNotification" checked>
                                    <label class="form-check-label" for="smsNotification">
                                        短信通知
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveWarningSettings()">保存设置</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeWarningCharts();
    setupEventHandlers();
});

function initializeWarningCharts() {
    // 预警类型统计饼图
    const typeCtx = document.getElementById('warningTypeChart');
    if (typeCtx) {
        new Chart(typeCtx, {
            type: 'pie',
            data: {
                labels: ['病虫害', '环境异常', '设备故障', '生长异常', '其他'],
                datasets: [{
                    data: [30, 25, 20, 15, 10],
                    backgroundColor: [
                        '#dc3545',
                        '#ffc107', 
                        '#6c757d',
                        '#28a745',
                        '#17a2b8'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // 预警趋势折线图
    const trendCtx = document.getElementById('warningTrendChart');
    if (trendCtx) {
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月'],
                datasets: [{
                    label: '紧急预警',
                    data: [5, 3, 8, 4, 6, 7, 2],
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4
                }, {
                    label: '重要预警',
                    data: [12, 8, 15, 10, 13, 16, 5],
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.4
                }, {
                    label: '一般预警',
                    data: [20, 15, 25, 18, 22, 28, 8],
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }
}

function setupEventHandlers() {
    // 刷新预警按钮
    document.getElementById('refreshWarnings').addEventListener('click', refreshWarnings);
    
    // 新增预警按钮
    document.getElementById('addWarning').addEventListener('click', function() {
        // 这里可以添加新增预警的逻辑
        alert('新增预警功能');
    });
    
    // 预警筛选按钮
    document.querySelectorAll('[data-filter]').forEach(button => {
        button.addEventListener('click', function() {
            // 更新按钮状态
            document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // 筛选预警
            const filter = this.dataset.filter;
            filterWarnings(filter);
        });
    });
}

function refreshWarnings() {
    // 直接更新预警数据
    updateWarningStats();
    updateWarningList();
    
    // 添加更新动画
    animateWarningUpdate();
    
    // 显示简短提示
    showAlert('预警数据已更新', 'info');
}

function updateWarningStats() {
    // 更新统计卡片
    const urgentCount = Math.floor(Math.random() * 5) + 1;
    const importantCount = Math.floor(Math.random() * 10) + 3;
    const normalCount = Math.floor(Math.random() * 15) + 5;
    const processedCount = Math.floor(Math.random() * 20) + 20;
    
    document.querySelector('.col-lg-3:nth-child(1) h4').textContent = urgentCount;
    document.querySelector('.col-lg-3:nth-child(2) h4').textContent = importantCount;
    document.querySelector('.col-lg-3:nth-child(3) h4').textContent = normalCount;
    document.querySelector('.col-lg-3:nth-child(4) h4').textContent = processedCount;
}

function updateWarningList() {
    // 更新预警列表
    const warnings = [
        { type: '病虫害检测', message: '发现蚜虫聚集，建议立即处理', level: '紧急', time: '刚刚' },
        { type: '土壤湿度异常', message: '土壤湿度过低，需要增加灌溉', level: '重要', time: '2分钟前' },
        { type: '温度异常', message: '温度过高，可能影响果实品质', level: '重要', time: '5分钟前' },
        { type: '设备故障', message: '传感器SN001通信异常', level: '一般', time: '10分钟前' },
        { type: '生长异常', message: '部分植株出现叶片黄化', level: '一般', time: '15分钟前' }
    ];
    
    const tbody = document.getElementById('warningTableBody');
    tbody.innerHTML = '';
    
    warnings.forEach(warning => {
        const row = document.createElement('tr');
        const levelClass = warning.level === '紧急' ? 'bg-danger' : 
                          warning.level === '重要' ? 'bg-warning' : 'bg-info';
        
        row.innerHTML = `
            <td>${warning.type}</td>
            <td>${warning.message}</td>
            <td><span class="badge ${levelClass}">${warning.level}</span></td>
            <td>${warning.time}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="handleWarning(this)">
                    <i class="fas fa-check"></i> 处理
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function handleWarning(button) {
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
    button.disabled = true;
    
    setTimeout(() => {
        // 更新状态为已处理
        const row = button.closest('tr');
        const levelBadge = row.querySelector('.badge');
        levelBadge.textContent = '已处理';
        levelBadge.className = 'badge bg-success';
        
        // 更新按钮
        button.innerHTML = '<i class="fas fa-check"></i> 已处理';
        button.className = 'btn btn-sm btn-success';
        
        // 显示成功消息
        showAlert('预警已处理', 'success');
        
        // 更新统计数据
        const processedCount = parseInt(document.querySelector('.col-lg-3:nth-child(4) h4').textContent);
        document.querySelector('.col-lg-3:nth-child(4) h4').textContent = processedCount + 1;
        
        // 减少对应级别的数量
        const currentLevel = row.querySelector('.badge').textContent;
        if (currentLevel.includes('紧急')) {
            const urgentCount = parseInt(document.querySelector('.col-lg-3:nth-child(1) h4').textContent);
            if (urgentCount > 0) {
                document.querySelector('.col-lg-3:nth-child(1) h4').textContent = urgentCount - 1;
            }
        }
    }, 1000);
}

function filterWarnings(filter) {
    const tbody = document.getElementById('warningTableBody');
    const rows = tbody.querySelectorAll('tr');
    
    rows.forEach(row => {
        if (filter === 'all') {
            row.style.display = '';
        } else {
            // 根据筛选条件显示/隐藏行
            // 这里需要根据实际的预警级别来判断
            const levelBadge = row.querySelector('.badge');
            if (levelBadge) {
                const level = levelBadge.textContent.trim();
                let shouldShow = false;
                
                switch (filter) {
                    case 'urgent':
                        shouldShow = level === '紧急';
                        break;
                    case 'important':
                        shouldShow = level === '重要';
                        break;
                    case 'normal':
                        shouldShow = level === '一般';
                        break;
                    case 'processed':
                        shouldShow = row.querySelector('.badge.bg-success') !== null;
                        break;
                }
                
                row.style.display = shouldShow ? '' : 'none';
            }
        }
    });
}

function saveWarningSettings() {
    // 获取表单数据
    const form = document.getElementById('warningSettingsForm');
    const formData = new FormData(form);
    
    // 模拟保存设置
    console.log('保存预警设置');
    
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('warningSettingsModal'));
    modal.hide();
    
    // 显示成功消息
    showAlert('预警设置已保存', 'success');
}

function animateWarningUpdate() {
    // 为统计卡片添加动画
    const statCards = document.querySelectorAll('.col-lg-3 .card');
    statCards.forEach((card, index) => {
        setTimeout(() => {
            card.style.transform = 'scale(1.03)';
            card.style.transition = 'transform 0.3s ease';
            card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            
            setTimeout(() => {
                card.style.transform = 'scale(1)';
                card.style.boxShadow = '';
            }, 400);
        }, index * 100);
    });
    
    // 为预警列表添加波动效果
    const alertsList = document.querySelector('#warningTableBody');
    if (alertsList) {
        alertsList.style.backgroundColor = '#f8f9fa';
        alertsList.style.transition = 'background-color 0.5s ease';
        setTimeout(() => {
            alertsList.style.backgroundColor = '';
        }, 800);
    }
}

function showAlert(message, type) {
    // 创建简短的toast提示
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.3s ease;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    `;
    
    const icon = type === 'success' ? 'check-circle' : 
                 type === 'info' ? 'info-circle' : 
                 type === 'warning' ? 'exclamation-triangle' : 'times-circle';
    toast.innerHTML = `<i class="fas fa-${icon} me-2"></i>${message}`;
    
    document.body.appendChild(toast);
    
    // 显示动画
    setTimeout(() => {
        toast.style.opacity = '1';
    }, 100);
    
    // 自动移除
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 2000);
}
</script>
{% endblock %} 